<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجوزات نسر السحاب</title>
    
    <!-- PWA (Progressive Web App) Configuration -->
    <meta name="theme-color" content="#14b8a6"/>
    <link rel="apple-touch-icon" href="https://i.imgur.com/gA32Alp.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"حجوزات نسر السحاب","short_name":"نسر السحاب","start_url":".","display":"standalone","background_color":"#f7fafc","theme_color":"#14b8a6","description":"نظام إدارة ومتابعة حجوزات نسر السحاب.","icons":[{"src":"https://i.imgur.com/gA32Alp.png","sizes":"192x192","type":"image/png"},{"src":"https://i.imgur.com/8z3a3Yj.png","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f7fafc;
        }
        .section {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .completed-card {
            opacity: 0.7;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        .status-indicator {
            position: fixed;
            top: 1rem;
            left: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: bold;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .online {
            background-color: #dcfce7;
            color: #166534;
        }
        .offline {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .gemini-button {
            background-color: #E6E6FA;
            color: #4B0082;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .gemini-button:hover {
            background-color: #D8BFD8;
        }
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .nav-button.active {
            background-color: #ccfbf1;
            color: #0f766e;
            border-color: #14b8a6;
        }
        .nav-button:not(.active) {
            background-color: #f1f5f9;
            color: #64748b;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="status-indicator" class="status-indicator"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">حجوزات نسر السحاب</h1>
            <p class="text-gray-500 mt-2">نظام إدارة ومتابعة الحجوزات</p>
        </header>

        <!-- Main Content Area -->
        <div id="main-content">
            <!-- Navigation Tabs -->
            <div class="flex justify-center gap-4 mb-6">
                <button id="nav-upcoming" class="nav-button active">الحجوزات القادمة</button>
                <button id="nav-completed" class="nav-button">أرشيف الرحلات</button>
            </div>

            <!-- Upcoming Bookings View -->
            <div id="upcoming-view" class="section">
                <!-- Accounting Summary -->
                <div id="accounting-summary" class="mb-6 bg-gradient-to-r from-teal-500 to-cyan-600 text-white p-6 rounded-xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold opacity-80">إجمالي المبالغ المستلمة (من الرحلات المكتملة)</h3>
                    <p id="total-revenue" class="text-4xl font-bold mt-2">0.00 ر.س</p>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-teal-600">قائمة الحجوزات</h2>
                        <button id="add-booking-btn" class="w-full sm:w-auto bg-teal-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 text-center">
                            إضافة حجز جديد
                        </button>
                    </div>
                    <div id="loader-upcoming" class="text-center py-10">
                        <p class="text-gray-500">جاري تحميل البيانات...</p>
                    </div>
                    <div id="bookings-grid-upcoming"></div>
                    <div id="no-bookings-upcoming" class="hidden text-center py-10">
                        <p class="text-gray-500">لا توجد حجوزات قادمة مسجلة.</p>
                    </div>
                </div>
            </div>

            <!-- Completed Bookings View -->
            <div id="completed-view" class="section hidden">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-700 mb-6 border-b pb-4">أرشيف الرحلات المكتملة</h2>
                    <div id="loader-completed" class="text-center py-10">
                        <p class="text-gray-500">جاري تحميل البيانات...</p>
                    </div>
                    <div id="bookings-grid-completed"></div>
                    <div id="no-bookings-completed" class="hidden text-center py-10">
                        <p class="text-gray-500">لا توجد حجوزات مكتملة في الأرشيف.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="form-view" class="section hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 id="form-title" class="text-2xl font-bold text-teal-600">إضافة حجز جديد</h2>
                    <button id="back-to-list-btn" class="text-teal-600 hover:text-teal-800 transition">&larr; العودة للقائمة</button>
                </div>
                <form id="booking-form" class="space-y-4">
                    <input type="hidden" id="edit-id" name="edit-id">
                    <div>
                        <label for="trip_name" class="block text-sm font-medium text-gray-600 mb-1">اسم الرحلة / الوجهة</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="trip_name" name="trip_name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="مثال: رحلة العمرة" required>
                            <button type="button" id="suggest-name-btn" class="gemini-button" title="✨ اقتراح اسم للرحلة">✨</button>
                        </div>
                    </div>
                    <div>
                        <label for="customer_name" class="block text-sm font-medium text-gray-600 mb-1">اسم الزبون</label>
                        <input type="text" id="customer_name" name="customer_name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="الاسم الكامل للزبون" required>
                    </div>
                    <div>
                        <label for="customer_phone" class="block text-sm font-medium text-gray-600 mb-1">رقم الجوال</label>
                        <input type="tel" id="customer_phone" name="customer_phone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="05xxxxxxxx" required dir="ltr">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="deposit" class="block text-sm font-medium text-gray-600 mb-1">العربون</label>
                            <input type="number" step="any" id="deposit" name="deposit" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="total_price" class="block text-sm font-medium text-gray-600 mb-1">السعر الإجمالي</label>
                            <input type="number" step="any" id="total_price" name="total_price" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="0.00" required>
                        </div>
                    </div>
                    <div>
                        <label for="departure_date" class="block text-sm font-medium text-gray-600 mb-1">تاريخ الذهاب</label>
                        <input type="date" id="departure_date" name="departure_date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" required>
                    </div>
                    <div>
                        <label for="trip_time" class="block text-sm font-medium text-gray-600 mb-1">وقت الذهاب</label>
                        <input type="time" id="trip_time" name="trip_time" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" required>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-600 mb-2">تفاصيل العودة (اختياري)</p>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="return_date" class="block text-sm text-gray-500 mb-1">تاريخ العودة</label>
                                <input type="date" id="return_date" name="return_date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            </div>
                            <div>
                                <label for="return_time" class="block text-sm text-gray-500 mb-1">وقت العودة</label>
                                <input type="time" id="return_time" name="return_time" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            </div>
                        </div>
                    </div>
                     <div>
                        <label for="notes" class="block text-sm font-medium text-gray-600 mb-1">ملاحظات</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="أضف أي ملاحظات خاصة بالحجز هنا..."></textarea>
                    </div>
                    <!-- Payment Method -->
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">طريقة الدفع</label>
                        <div class="flex gap-x-6">
                            <div class="flex items-center">
                                <input id="payment_cash" name="payment_method" type="radio" value="كاش" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 ml-2" checked>
                                <label for="payment_cash" class="block text-sm text-gray-900">كاش</label>
                            </div>
                            <div class="flex items-center">
                                <input id="payment_transfer" name="payment_method" type="radio" value="تحويل بنكي" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 ml-2">
                                <label for="payment_transfer" class="block text-sm text-gray-900">تحويل بنكي</label>
                            </div>
                        </div>
                    </div>
                    <div class="pt-2 space-y-3">
                        <div class="flex items-center">
                            <input id="is_contract_written" name="is_contract_written" type="checkbox" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded ml-2">
                            <label for="is_contract_written" class="block text-sm font-medium text-gray-700">تمت كتابة العقد</label>
                        </div>
                        <div class="flex items-center">
                            <input id="is_manifest_sent" name="is_manifest_sent" type="checkbox" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded ml-2">
                            <label for="is_manifest_sent" class="block text-sm font-medium text-gray-700">تم إرسال كشف الركاب</label>
                        </div>
                    </div>

                    <button type="submit" id="submit-button" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105">
                        حفظ الحجز
                    </button>
                    <div id="form-error-message" class="hidden text-center mt-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
                </form>
            </div>
        </div>
        
        <div id="modal" class="modal-backdrop">
             <div class="modal-content">
                <p id="modal-message" class="text-lg whitespace-pre-wrap"></p>
                <div id="modal-buttons" class="mt-6 flex justify-center gap-4">
                    <button id="modal-copy" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hidden">نسخ النص</button>
                    <button id="modal-ok" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg">موافق</button>
                    <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg hidden">تأكيد الحذف</button>
                    <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg hidden">إلغاء</button>
                </div>
            </div>
        </div>

        <div id="pdf-content" class="hidden"></div>
    </div>

    <script>
        // --- 1. PWA Service Worker Registration ---
        const swContent = `
            const CACHE_NAME = 'nesr-alsahab-cache-v1';
            const urlsToCache = [
                '/',
                'https://cdn.tailwindcss.com',
                'https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap',
                'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2',
                'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js'
            ];
            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                );
            });
            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request).then(response => {
                        return response || fetch(event.request);
                    })
                );
            });
        `;
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('ServiceWorker registration successful.'))
                    .catch(error => console.log('ServiceWorker registration failed:', error));
            });
        }

        // --- 2. Supabase Client Setup ---
        const SUPABASE_URL = 'https://jhtjgvezufhgzyvdqjab.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpodGpndmV6dWZoZ3p5dmRxamFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzOTk0MzAsImV4cCI6MjA2ODk3NTQzMH0.vBQAKx5N_2byzv5CTdZ0billvq7MVuTRbos1A3Ux3xg';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 3. DOM Element References ---
        const mainContent = document.getElementById('main-content');
        const upcomingView = document.getElementById('upcoming-view');
        const completedView = document.getElementById('completed-view');
        const formView = document.getElementById('form-view');
        const navUpcomingBtn = document.getElementById('nav-upcoming');
        const navCompletedBtn = document.getElementById('nav-completed');
        const addBookingBtn = document.getElementById('add-booking-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const loaderUpcoming = document.getElementById('loader-upcoming');
        const loaderCompleted = document.getElementById('loader-completed');
        const bookingsGridUpcoming = document.getElementById('bookings-grid-upcoming');
        const bookingsGridCompleted = document.getElementById('bookings-grid-completed');
        const noBookingsUpcoming = document.getElementById('no-bookings-upcoming');
        const noBookingsCompleted = document.getElementById('no-bookings-completed');
        const totalRevenueEl = document.getElementById('total-revenue');
        const bookingForm = document.getElementById('booking-form');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const formErrorMessage = document.getElementById('form-error-message');
        const editIdInput = document.getElementById('edit-id');
        const statusIndicator = document.getElementById('status-indicator');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok');
        const modalConfirmButton = document.getElementById('modal-confirm');
        const modalCancelButton = document.getElementById('modal-cancel');
        const modalCopyButton = document.getElementById('modal-copy');
        const suggestNameBtn = document.getElementById('suggest-name-btn');
        
        // --- 4. Local Storage Management (Offline Cache) ---
        const getLocalBookings = () => JSON.parse(localStorage.getItem('bookings')) || [];
        const setLocalBookings = (bookings) => localStorage.setItem('bookings', JSON.stringify(bookings));
        const getSyncQueue = () => JSON.parse(localStorage.getItem('syncQueue')) || [];
        const setSyncQueue = (queue) => localStorage.setItem('syncQueue', JSON.stringify(queue));

        // --- 5. UI Functions (Modal, Views, Formatters) ---
        function showModal(message, options = {}) {
            const { isConfirmation = false, onConfirm = () => {}, showCopy = false } = options;
            modalMessage.textContent = message;
            modal.classList.add('visible');
            
            modalOkButton.classList.toggle('hidden', isConfirmation || showCopy);
            modalConfirmButton.classList.toggle('hidden', !isConfirmation);
            modalCancelButton.classList.toggle('hidden', !isConfirmation && !showCopy);
            modalCopyButton.classList.toggle('hidden', !showCopy);

            if (isConfirmation) {
                const newConfirmButton = modalConfirmButton.cloneNode(true);
                modalConfirmButton.parentNode.replaceChild(newConfirmButton, modalConfirmButton);
                newConfirmButton.addEventListener('click', () => {
                    closeModal();
                    onConfirm();
                });
            }
            if (showCopy) {
                modalCancelButton.classList.remove('hidden'); // Show cancel button with copy
                const newCopyButton = modalCopyButton.cloneNode(true);
                modalCopyButton.parentNode.replaceChild(newCopyButton, modalCopyButton);
                newCopyButton.addEventListener('click', () => {
                    const tempInput = document.createElement('textarea');
                    tempInput.value = message;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showModal('تم نسخ النص بنجاح!');
                });
            }
        }
        function closeModal() { modal.classList.remove('visible'); }
        
        function showView(viewToShow) {
            [upcomingView, completedView, formView].forEach(view => view.classList.add('hidden'));
            document.getElementById(viewToShow).classList.remove('hidden');

            [navUpcomingBtn, navCompletedBtn].forEach(btn => btn.classList.remove('active'));
            if (viewToShow === 'upcoming-view') navUpcomingBtn.classList.add('active');
            if (viewToShow === 'completed-view') navCompletedBtn.classList.add('active');
        }

        function showFormView(mode = 'add', bookingId = null) {
            showView('form-view');
            bookingForm.reset();
            editIdInput.value = '';
            formErrorMessage.classList.add('hidden');
            submitButton.disabled = false;

            if (mode === 'edit' && bookingId) {
                const allData = getLocalBookings();
                const bookingToEdit = allData.find(b => b.id == bookingId);
                if (bookingToEdit) {
                    formTitle.textContent = 'تعديل الحجز';
                    submitButton.textContent = 'تحديث الحجز';
                    editIdInput.value = bookingToEdit.id;
                    // Populate all fields...
                    document.getElementById('trip_name').value = bookingToEdit.trip_name;
                    document.getElementById('customer_name').value = bookingToEdit.customer_name;
                    document.getElementById('customer_phone').value = bookingToEdit.customer_phone;
                    document.getElementById('deposit').value = bookingToEdit.deposit;
                    document.getElementById('total_price').value = bookingToEdit.total_price;
                    document.getElementById('departure_date').value = bookingToEdit.departure_date;
                    document.getElementById('return_date').value = bookingToEdit.return_date || '';
                    document.getElementById('trip_time').value = bookingToEdit.trip_time;
                    document.getElementById('return_time').value = bookingToEdit.return_time || '';
                    document.getElementById('is_contract_written').checked = bookingToEdit.is_contract_written;
                    document.getElementById('is_manifest_sent').checked = bookingToEdit.is_manifest_sent;
                    document.getElementById('notes').value = bookingToEdit.notes || '';
                    if (bookingToEdit.payment_method === 'تحويل بنكي') {
                        document.getElementById('payment_transfer').checked = true;
                    } else {
                        document.getElementById('payment_cash').checked = true;
                    }
                } else {
                    showModal("لم يتم العثور على الحجز المطلوب للتعديل.");
                    showView('upcoming-view');
                }
            } else {
                formTitle.textContent = 'إضافة حجز جديد';
                submitButton.textContent = 'حفظ الحجز';
            }
        }

        function formatTime12Hour(timeString) {
            if (!timeString) return '';
            const dummyDate = new Date(`1970-01-01T${timeString}`);
            if (isNaN(dummyDate)) return timeString;
            return new Intl.DateTimeFormat('en-US', {
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            }).format(dummyDate);
        }
        
        // --- 6. Online/Offline Status Handling ---
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            statusIndicator.innerHTML = isOnline 
                ? `<span>🟢</span> متصل` 
                : `<span>🔴</span> غير متصل`;
            statusIndicator.className = 'status-indicator ' + (isOnline ? 'online' : 'offline');
            
            if (isOnline) {
                syncPendingOperations();
            }
        }

        // --- 7. Core Data Functions (Fetch, Render, Calculate) ---
        function calculateAndDisplayAccounting(completedBookings) {
            const totalRevenue = completedBookings.reduce((sum, booking) => {
                // Only add the price of departure trips to avoid double counting
                if (booking.trip_type === 'departure' || !booking.trip_type) {
                    return sum + (booking.total_price || 0);
                }
                return sum;
            }, 0);
            totalRevenueEl.textContent = `${totalRevenue.toFixed(2)} ر.س`;
        }

        async function fetchAndRenderBookings() {
            loaderUpcoming.classList.remove('hidden');
            loaderCompleted.classList.remove('hidden');
            
            // Render from local storage first for an instant UI.
            const allBookings = getLocalBookings();
            const upcomingBookings = allBookings.filter(b => !b.is_completed);
            const completedBookings = allBookings.filter(b => b.is_completed);
            renderBookingCards(upcomingBookings, bookingsGridUpcoming, noBookingsUpcoming);
            renderBookingCards(completedBookings, bookingsGridCompleted, noBookingsCompleted);
            calculateAndDisplayAccounting(completedBookings);

            if (navigator.onLine) {
                try {
                    const { data, error } = await db.from('bookings').select('*').order('departure_date', { ascending: true });
                    if (error) throw error;
                    
                    setLocalBookings(data);
                    const freshUpcoming = data.filter(b => !b.is_completed);
                    const freshCompleted = data.filter(b => b.is_completed);
                    renderBookingCards(freshUpcoming, bookingsGridUpcoming, noBookingsUpcoming);
                    renderBookingCards(freshCompleted, bookingsGridCompleted, noBookingsCompleted);
                    calculateAndDisplayAccounting(freshCompleted);
                } catch (error) {
                    console.error('Error fetching bookings:', error);
                    showModal('فشل الاتصال بالخادم. سيتم عرض البيانات المحلية.');
                }
            }
            loaderUpcoming.classList.add('hidden');
            loaderCompleted.classList.add('hidden');
        }

        function renderBookingCards(bookings, gridElement, noBookingsElement) {
            gridElement.innerHTML = '';
            const filteredBookings = bookings.filter(b => b.status !== 'deleted');
            noBookingsElement.classList.toggle('hidden', filteredBookings.length > 0);

            const bookingsByDate = filteredBookings.reduce((acc, booking) => {
                const date = booking.departure_date;
                if (!acc[date]) acc[date] = [];
                acc[date].push(booking);
                return acc;
            }, {});

            const sortedDates = Object.keys(bookingsByDate).sort((a, b) => new Date(a) - new Date(b));

            sortedDates.forEach(dateStr => {
                const dateHeaderContainer = document.createElement('div');
                dateHeaderContainer.className = 'col-span-full mb-4 mt-6';
                const date = new Date(dateStr);
                const utcDate = new Date(date.getTime() + (date.getTimezoneOffset() * 60000));
                
                const dayName = new Intl.DateTimeFormat('ar-SA', { weekday: 'long', calendar: 'gregory' }).format(utcDate);
                const gregorianDate = new Intl.DateTimeFormat('ar-SA-u-nu-latn', { year: 'numeric', month: 'numeric', day: 'numeric', calendar: 'gregory' }).format(utcDate);
                const hijriDate = new Intl.DateTimeFormat('ar-SA-u-nu-latn', { day: 'numeric', month: 'numeric', year: 'numeric', calendar: 'islamic-umalqura' }).format(utcDate);

                dateHeaderContainer.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 border-b-2 border-teal-500 pb-2 flex items-baseline flex-wrap gap-x-4 gap-y-1">
                        <span>${dayName}</span>
                        <span class="text-lg font-medium text-gray-700">${gregorianDate}</span>
                        <span class="text-base font-normal text-gray-500">(${hijriDate})</span>
                    </h2>
                `;
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6';
                
                bookingsByDate[dateStr].forEach(booking => {
                    const remaining = (booking.total_price || 0) - (booking.deposit || 0);
                    const card = document.createElement('div');

                    let cardClasses = 'bg-white p-4 rounded-lg shadow-md border-l-4 flex flex-col justify-between transition-transform transform hover:scale-105 relative';
                    let alertHtml = '';
                    const today = new Date(); today.setHours(0,0,0,0);
                    const bookingDate = new Date(booking.departure_date); bookingDate.setHours(0,0,0,0);
                    const dayDiff = Math.ceil((bookingDate.getTime() - today.getTime()) / (1000 * 3600 * 24));

                    if (booking.is_completed) {
                        cardClasses += ' border-gray-400 completed-card';
                        alertHtml = `<div class="absolute top-2 left-2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full">✓ مكتملة</div>`;
                    } else if (dayDiff === 1) {
                        cardClasses += ' border-red-500 bg-red-50';
                        alertHtml = `<div class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">تنبيه: الحجز غداً</div>`;
                    } else if (dayDiff === 0) {
                        cardClasses += ' border-yellow-500 bg-yellow-50';
                        alertHtml = `<div class="absolute top-2 left-2 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">تنبيه: الحجز اليوم</div>`;
                    } else {
                        cardClasses += ' border-teal-500';
                    }
                     if (booking.synced === false) {
                         alertHtml += `<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full" title="لم تتم المزامنة بعد">☁️</div>`;
                    }
                    if (booking.trip_type === 'return') {
                        alertHtml += `<div class="absolute top-10 right-2 bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full" title="رحلة عودة">🔄</div>`;
                    }
                    
                    const paymentMethod = booking.payment_method || 'كاش';

                    card.className = cardClasses;
                    card.innerHTML = `
                        ${alertHtml}
                        <div>
                            <h3 class="font-bold text-lg text-teal-700 mb-2 pt-5">${booking.trip_name}</h3>
                            <p class="text-sm text-gray-600"><span class="font-semibold">الزبون:</span> ${booking.customer_name}</p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">الجوال:</span> <span dir="ltr" class="inline-block">${booking.customer_phone}</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">الوقت:</span> ${formatTime12Hour(booking.trip_time)}</p>
                            
                            <div class="mt-3 pt-3 border-t border-gray-200 text-sm space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">طريقة الدفع:</span>
                                    <button data-action="togglePayment" data-id="${booking.id}" class="font-bold px-2 py-1 rounded-full text-xs transition-colors ${paymentMethod === 'تحويل بنكي' ? 'bg-blue-100 text-blue-800 hover:bg-blue-200' : 'bg-green-100 text-green-800 hover:bg-green-200'}">
                                        ${paymentMethod}
                                    </button>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">حالة العقد:</span>
                                    <span class="font-bold px-2 py-1 rounded-full text-xs ${booking.is_contract_written ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${booking.is_contract_written ? 'مكتوب' : 'غير مكتوب'}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">كشف الركاب:</span>
                                     <span class="font-bold px-2 py-1 rounded-full text-xs ${booking.is_manifest_sent ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${booking.is_manifest_sent ? 'مُرسل' : 'غير مُرسل'}
                                    </span>
                                </div>
                            </div>

                            <hr class="my-3">
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <p class="text-xs text-gray-500">الإجمالي</p>
                                    <p class="font-bold text-sm text-green-600">${booking.total_price} ر.س</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">العربون</p>
                                    <p class="font-bold text-sm text-blue-600">${booking.deposit} ر.س</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500">المتبقي</p>
                                    <p class="font-bold text-sm text-red-600">${remaining.toFixed(2)} ر.س</p>
                                </div>
                            </div>
                            
                            ${booking.notes ? `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-sm font-bold text-gray-700">ملاحظات:</p>
                                <p class="text-sm text-gray-600 whitespace-pre-wrap">${booking.notes}</p>
                            </div>
                            ` : ''}
                        </div>
                        <div class="mt-4 flex justify-between items-center gap-2">
                            <div class="flex items-center gap-2">
                                <button data-action="print" data-id="${booking.id}" class="text-gray-400 hover:text-blue-600 p-1 transition" title="طباعة الحجز">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM9 12a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM4 5.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z"/></svg>
                                </button>
                                <button data-action="toggleComplete" data-id="${booking.id}" class="text-gray-400 hover:text-green-600 p-1 transition" title="${booking.is_completed ? 'إلغاء اكتمال الرحلة' : 'تحديد كـ (تمت الرحلة)'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
                                </button>
                                <button data-action="toggleContract" data-id="${booking.id}" class="text-gray-400 hover:text-purple-600 p-1 transition" title="تغيير حالة العقد">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
                                </button>
                                <button data-action="toggleManifest" data-id="${booking.id}" class="text-gray-400 hover:text-orange-600 p-1 transition" title="تغيير حالة كشف الركاب">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM5 4h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1zm0 2h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1zm0 2h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1zm0 2h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1z"/></svg>
                                </button>
                                <button data-action="generateMessage" data-id="${booking.id}" class="text-gray-400 hover:text-cyan-500 p-1 transition" title="✨ إنشاء رسالة تأكيد للعميل">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.89 7.89 0 0 0 13.6 2.326zM7.994 14.521a6.57 6.57 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/></svg>
                                </button>
                                <button data-action="generateReminder" data-id="${booking.id}" class="text-gray-400 hover:text-indigo-500 p-1 transition" title="✨ إنشاء رسالة تذكير للعميل">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-person-lines-fill" viewBox="0 0 16 16"><path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"/></svg>
                                </button>
                            </div>
                            <div class="${booking.is_completed ? 'hidden' : ''}">
                                <button data-action="edit" data-id="${booking.id}" class="text-blue-500 hover:text-blue-700 text-xs font-semibold transition">تعديل</button>
                                <button data-action="delete" data-id="${booking.id}" class="text-gray-400 hover:text-red-600 text-xs transition mr-2">حذف</button>
                            </div>
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                });
                gridElement.appendChild(dateHeaderContainer);
                gridElement.appendChild(cardsContainer);
            });
        }

        // --- 8. User Actions (Submit, Delete, Toggles) ---
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = editIdInput.value;
            const bookingData = {
                trip_name: document.getElementById('trip_name').value,
                customer_name: document.getElementById('customer_name').value,
                customer_phone: document.getElementById('customer_phone').value,
                deposit: parseFloat(document.getElementById('deposit').value) || 0,
                total_price: parseFloat(document.getElementById('total_price').value) || 0,
                departure_date: document.getElementById('departure_date').value,
                return_date: document.getElementById('return_date').value || null,
                trip_time: document.getElementById('trip_time').value,
                return_time: document.getElementById('return_time').value || null,
                is_contract_written: document.getElementById('is_contract_written').checked,
                is_manifest_sent: document.getElementById('is_manifest_sent').checked,
                notes: document.getElementById('notes').value.trim(),
                payment_method: document.querySelector('input[name="payment_method"]:checked').value,
                trip_type: 'departure'
            };

            // Handle return trip creation
            if (!editId && bookingData.return_date && bookingData.return_time) {
                const returnBookingData = {
                    ...bookingData,
                    trip_name: `عودة: ${bookingData.trip_name}`,
                    departure_date: bookingData.return_date,
                    trip_time: bookingData.return_time,
                    return_date: null,
                    return_time: null,
                    total_price: 0, // Price is for the round trip
                    deposit: 0,
                    trip_type: 'return',
                    // We will link them after the first one is created
                };
                
                // We will insert both bookings
                handleDoubleInsert(bookingData, returnBookingData);
            } else {
                // Handle single insert or update
                handleSingleSave(bookingData, editId);
            }
        });

        async function handleSingleSave(bookingData, editId) {
             if (navigator.onLine) {
                submitButton.disabled = true;
                submitButton.textContent = editId ? 'جاري التحديث...' : 'جاري الحفظ...';
                
                const { data, error } = editId
                    ? await db.from('bookings').update(bookingData).eq('id', editId).select()
                    : await db.from('bookings').insert([bookingData]).select();

                submitButton.disabled = false;
                submitButton.textContent = editId ? 'تحديث الحجز' : 'حفظ الحجز';

                if (error) {
                    showModal('حدث خطأ أثناء الحفظ في قاعدة البيانات.');
                } else {
                    showModal(editId ? 'تم تحديث الحجز بنجاح!' : 'تم حفظ الحجز بنجاح!');
                    showView('upcoming-view');
                    await fetchAndRenderBookings();
                }
            } else {
                // OFFLINE: Save to local storage and queue
                const localBookings = getLocalBookings();
                const queue = getSyncQueue();
                
                if (editId) {
                    const index = localBookings.findIndex(b => b.id == editId);
                    if (index > -1) {
                        localBookings[index] = { ...localBookings[index], ...bookingData, synced: false };
                        queue.push({ action: 'update', payload: { ...bookingData, id: editId } });
                    }
                } else {
                    const tempId = `offline_${Date.now()}`;
                    const newBooking = { ...bookingData, id: tempId, synced: false };
                    localBookings.push(newBooking);
                    queue.push({ action: 'insert', payload: newBooking });
                }
                
                setLocalBookings(localBookings);
                setSyncQueue(queue);
                renderBookingCards(localBookings, bookingsGridUpcoming, noBookingsUpcoming);
                showView('upcoming-view');
                showModal('أنت غير متصل. تم حفظ الحجز محلياً وسيتم مزامنته عند عودة الاتصال.');
            }
        }

        async function handleDoubleInsert(departureData, returnData) {
            if (navigator.onLine) {
                submitButton.disabled = true;
                submitButton.textContent = 'جاري حفظ الذهاب والعودة...';

                // 1. Insert departure
                const { data: depData, error: depError } = await db.from('bookings').insert(departureData).select().single();
                
                if (depError) {
                    showModal('حدث خطأ أثناء حفظ رحلة الذهاب.');
                    submitButton.disabled = false;
                    return;
                }

                // 2. Link and insert return
                returnData.parent_booking_id = depData.id;
                const { error: retError } = await db.from('bookings').insert(returnData);

                if (retError) {
                    showModal('تم حفظ رحلة الذهاب، ولكن حدث خطأ أثناء حفظ رحلة العودة.');
                } else {
                    showModal('تم حفظ حجزي الذهاب والعودة بنجاح!');
                }
                
                submitButton.disabled = false;
                showView('upcoming-view');
                await fetchAndRenderBookings();

            } else {
                // Offline handling for round trips
                const localBookings = getLocalBookings();
                const queue = getSyncQueue();

                const depTempId = `offline_${Date.now()}`;
                const retTempId = `offline_${Date.now() + 1}`;

                departureData.id = depTempId;
                departureData.synced = false;
                
                returnData.id = retTempId;
                returnData.parent_booking_id = depTempId;
                returnData.synced = false;

                localBookings.push(departureData, returnData);
                queue.push({ action: 'insert', payload: departureData }, { action: 'insert', payload: returnData });

                setLocalBookings(localBookings);
                setSyncQueue(queue);
                renderBookingCards(localBookings, bookingsGridUpcoming, noBookingsUpcoming);
                showView('upcoming-view');
                showModal('أنت غير متصل. تم حفظ حجزي الذهاب والعودة محلياً.');
            }
        }
        
        async function updateField(id, field, newValue) {
            const isOnline = navigator.onLine;
            const localBookings = getLocalBookings();
            const index = localBookings.findIndex(b => b.id == id);
            if (index === -1) return;

            const oldValue = localBookings[index][field];
            localBookings[index][field] = newValue;
            
            if (isOnline) {
                const { error } = await db.from('bookings').update({ [field]: newValue }).eq('id', id);
                if (error) {
                    showModal(`حدث خطأ أثناء تحديث الحقل.`);
                    localBookings[index][field] = oldValue; // Revert on error
                } else {
                    localBookings[index].synced = true;
                }
            } else {
                localBookings[index].synced = false;
                const queue = getSyncQueue();
                queue.push({ action: 'update', payload: { id, [field]: newValue } });
                setSyncQueue(queue);
                showModal('تم تحديث الحقل محلياً. ستتم المزامنة عند عودة الاتصال.');
            }
            setLocalBookings(localBookings);
            fetchAndRenderBookings();
        }

        function handleCardAction(action, id) {
            const booking = getLocalBookings().find(b => b.id == id);
            if (!booking) return;

            switch (action) {
                case 'print':
                    handlePrint(id);
                    break;
                case 'toggleComplete':
                    updateField(id, 'is_completed', !booking.is_completed);
                    break;
                case 'toggleContract':
                    updateField(id, 'is_contract_written', !booking.is_contract_written);
                    break;
                case 'toggleManifest':
                    updateField(id, 'is_manifest_sent', !booking.is_manifest_sent);
                    break;
                case 'togglePayment':
                    const newMethod = (booking.payment_method || 'كاش') === 'كاش' ? 'تحويل بنكي' : 'كاش';
                    updateField(id, 'payment_method', newMethod);
                    break;
                case 'generateMessage':
                    generateConfirmationMessage(id);
                    break;
                case 'generateReminder':
                    generateManifestReminderMessage(id);
                    break;
                case 'edit':
                    showFormView('edit', id);
                    break;
                case 'delete':
                    handleDelete(id);
                    break;
            }
        }

        function handleDelete(id) {
            showModal('هل أنت متأكد من أنك تريد حذف هذا الحجز؟', { isConfirmation: true, onConfirm: async () => {
                if (navigator.onLine) {
                    const { error } = await db.from('bookings').delete().eq('id', id);
                    if (error) {
                        showModal('فشل حذف الحجز من قاعدة البيانات.');
                    } else {
                        showModal('تم حذف الحجز بنجاح.');
                        await fetchAndRenderBookings();
                    }
                } else {
                    const localBookings = getLocalBookings();
                    const index = localBookings.findIndex(b => b.id == id);
                    if (index > -1) {
                        localBookings[index].status = 'deleted'; // Mark for deletion
                        setLocalBookings(localBookings);
                        
                        const queue = getSyncQueue();
                        const queueIndex = queue.findIndex(op => op.action === 'insert' && op.payload.id === id);
                        if(queueIndex > -1) { 
                            queue.splice(queueIndex, 1);
                        } else { 
                            queue.push({ action: 'delete', payload: { id } });
                        }
                        setSyncQueue(queue);
                        
                        fetchAndRenderBookings();
                        showModal('تم حذف الحجز محلياً. سيتم الحذف نهائياً عند عودة الاتصال.');
                    }
                }
            }});
        };

        function handlePrint(bookingId) {
            const booking = getLocalBookings().find(b => b.id == bookingId);
            if (!booking) { return showModal("لم يتم العثور على الحجز للطباعة."); }

            const remaining = (booking.total_price || 0) - (booking.deposit || 0);
            const printContent = `
                <div dir="rtl" style="font-family: Tajawal, sans-serif; padding: 20px; border: 1px solid #ccc; width: 400px; margin: auto;">
                    <h1 style="text-align: center; color: #0d9488;">حجوزات نسر السحاب</h1>
                    <h2 style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">إيصال حجز</h2>
                    <p><strong>الرحلة:</strong> ${booking.trip_name}</p>
                    <p><strong>الزبون:</strong> ${booking.customer_name}</p>
                    <p><strong>الجوال:</strong> ${booking.customer_phone}</p>
                    <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
                    <p><strong>تاريخ الذهاب:</strong> ${booking.departure_date}</p>
                    <p><strong>وقت الرحلة:</strong> ${booking.trip_time}</p>
                    ${booking.return_date ? `<p><strong>تاريخ العودة:</strong> ${booking.return_date}</p>` : ''}
                    <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
                    <table style="width: 100%; text-align: right;">
                        <tr><td>السعر الإجمالي:</td><td style="text-align: left;">${booking.total_price} ر.س</td></tr>
                        <tr><td>العربون (مدفوع):</td><td style="text-align: left;">${booking.deposit} ر.س</td></tr>
                        <tr style="font-weight: bold; border-top: 1px solid #eee; padding-top: 5px;"><td>المبلغ المتبقي:</td><td style="text-align: left;">${remaining.toFixed(2)} ر.س</td></tr>
                    </table>
                     <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
                        <p><strong>طريقة الدفع:</strong> ${booking.payment_method || 'غير محدد'}</p>
                        <p><strong>حالة العقد:</strong> ${booking.is_contract_written ? 'مكتوب' : 'غير مكتوب'}</p>
                        <p><strong>كشف الركاب:</strong> ${booking.is_manifest_sent ? 'مُرسل' : 'غير مُرسل'}</p>
                    </div>
                    ${booking.notes ? `
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
                        <p><strong>ملاحظات:</strong></p>
                        <p>${booking.notes}</p>
                    </div>
                    ` : ''}
                    <p style="text-align: center; font-size: 12px; color: #888; margin-top: 20px;">شكراً لاختياركم نسر السحاب</p>
                </div>
            `;
            
            const element = document.getElementById('pdf-content');
            element.innerHTML = printContent;
            
            html2pdf(element, {
                margin: 10,
                filename: `booking_${booking.customer_name}_${booking.id}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' }
            });
        };

        // --- 9. Gemini AI Features ---
        async function callGemini(prompt) {
            showModal("✨ جاري الاستعانة بالذكاء الاصطناعي...");
            const apiUrl = '/.netlify/functions/gemini';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Netlify Function Error Body:", errorBody);
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                return result.response;

            } catch (error) {
                console.error("Error calling Netlify function:", error);
                showModal("حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى التأكد من إعداد مفتاح API في Netlify وإعادة نشر الموقع.");
                return null;
            }
        }

        async function suggestTripName() {
            const destination = document.getElementById('trip_name').value.trim();
            if (!destination) {
                showModal("يرجى إدخال وجهة الرحلة أولاً.");
                return;
            }
            
            const prompt = `اقترح 5 أسماء إبداعية لرحلة نقل متجهة إلى "${destination}". يجب أن تكون الأسماء قصيرة ومناسبة لشركة نقل سعودية. قدم الأسماء فقط في قائمة مرقمة بدون أي مقدمات أو خواتيم.`;
            const suggestions = await callGemini(prompt);
            
            if (suggestions) {
                showModal(`✨ اقتراحات لاسم الرحلة:\n\n${suggestions}`, { showCopy: true });
            }
        }

        async function generateConfirmationMessage(bookingId) {
            const booking = getLocalBookings().find(b => b.id == bookingId);
            if (!booking) return;

            const remaining = (booking.total_price || 0) - (booking.deposit || 0);
            const prompt = `
                أنت موظف في شركة 'نسر السحاب' للنقل. قم بصياغة رسالة تأكيد حجز احترافية وودودة لإرسالها للعميل عبر الواتساب.
                استخدم التفاصيل التالية:
                - اسم العميل: ${booking.customer_name}
                - وجهة الرحلة: ${booking.trip_name}
                - تاريخ الذهاب: ${booking.departure_date}
                - الوقت: ${formatTime12Hour(booking.trip_time)}
                - السعر الإجمالي: ${booking.total_price} ريال سعودي
                - العربون: ${booking.deposit} ريال سعودي
                - المبلغ المتبقي: ${remaining.toFixed(2)} ريال سعودي
                
                يجب أن تكون الرسالة باللغة العربية. ابدأ الرسالة بـ 'السلام عليكم ورحمة الله وبركاته، أستاذ/ة ${booking.customer_name}' واختتمها بـ 'نسعد بخدمتكم، فريق نسر السحاب'.
            `;
            
            const message = await callGemini(prompt);
            if (message) {
                showModal(message, { showCopy: true });
            }
        }

        async function generateManifestReminderMessage(bookingId) {
            const booking = getLocalBookings().find(b => b.id == bookingId);
            if (!booking) return;

            const prompt = `
                أنت موظف في شركة 'نسر السحاب' للنقل. قم بصياغة رسالة تذكير لطيفة ومهذبة لإرسالها للعميل عبر الواتساب.
                الهدف من الرسالة هو تذكير العميل بضرورة إرسال أسماء وبيانات المرافقين معه في الرحلة لإضافتهم إلى كشف الركاب وتأكيد الحجز بشكل نهائي.
                - اسم العميل: ${booking.customer_name}
                - وجهة الرحلة: ${booking.trip_name}
                - تاريخ الذهاب: ${booking.departure_date}

                اجعل الرسالة قصيرة ومباشرة. ابدأ بـ 'السلام عليكم أستاذ/ة ${booking.customer_name}،' واختتمها بشكر العميل على تعاونه.
            `;

            const message = await callGemini(prompt);
            if (message) {
                showModal(message, { showCopy: true });
            }
        }


        // --- 10. Offline Data Synchronization Logic ---
        async function syncPendingOperations() {
            const queue = getSyncQueue();
            if (queue.length === 0) { return; }
            
            showModal(`جاري مزامنة ${queue.length} عملية...`);

            let failedOperations = [];
            
            for (const operation of queue) {
                let error = null;
                try {
                    switch (operation.action) {
                        case 'insert':
                            const { id, synced, ...insertPayload } = operation.payload;
                            ({ error } = await db.from('bookings').insert(insertPayload));
                            break;
                        case 'update':
                            const { id: updateId, synced: updateSynced, ...updatePayload } = operation.payload;
                            ({ error } = await db.from('bookings').update(updatePayload).eq('id', updateId));
                            break;
                        case 'delete':
                            ({ error } = await db.from('bookings').delete().eq('id', operation.payload.id));
                            break;
                    }
                    if (error) throw error;
                } catch (e) {
                    console.error('Sync failed for operation:', operation, e);
                    failedOperations.push(operation);
                }
            }
            
            setSyncQueue(failedOperations);
            if(failedOperations.length === 0) {
                showModal('تمت مزامنة جميع البيانات بنجاح!');
            } else {
                showModal(`فشلت مزامنة ${failedOperations.length} عملية. سيتم المحاولة لاحقاً.`);
            }
            await fetchAndRenderBookings(); // Refresh all data from server
        }

        // --- 11. Initial Load & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            modal.classList.remove('visible');
            updateOnlineStatus();
            fetchAndRenderBookings();
            
            navUpcomingBtn.addEventListener('click', () => showView('upcoming-view'));
            navCompletedBtn.addEventListener('click', () => showView('completed-view'));
            addBookingBtn.addEventListener('click', () => showFormView('add'));
            backToListBtn.addEventListener('click', () => showView('upcoming-view'));
            suggestNameBtn.addEventListener('click', suggestTripName);

            mainContent.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const action = button.dataset.action;
                const id = button.dataset.id;
                
                if (action && id) {
                    handleCardAction(action, id);
                }
            });

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            modalOkButton.addEventListener('click', closeModal);
            modalCancelButton.addEventListener('click', closeModal);
        });

    </script>
</body>
</html>
